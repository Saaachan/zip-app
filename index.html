<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Zip Search</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f9fb8">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');

:root {
  --bg:#f4f8fb;
  --text:#2f3a40;
  --title:#3e7c92;
  --accent:#4f9fb8;
  --card:#ffffff;
  --border:#e3f0f5;
  --input-border:#cfe3ea;
  --brown:#4a3f35;
  --toggle-bg:#ddeff5;
}

body.dark {
  --bg:#11161a;
  --text:#e6edf1;
  --title:#7cc3da;
  --accent:#3c8aa3;
  --card:#1b2227;
  --border:#2a343a;
  --input-border:#2a343a;
  --brown:#e6ded6;
  --toggle-bg:#222c31;
}

body{
  font-family:'Zen Maru Gothic',sans-serif;
  background:var(--bg);
  margin:0;
  padding:60px 20px;
  display:flex;
  justify-content:center;
  color:var(--text);
  transition:background 0.3s ease,color 0.3s ease;
}

.container{width:100%;max-width:500px;}

.title{
  text-align:center;
  font-size:26px;
  font-weight:700;
  color:var(--title);
  margin-bottom:30px;
}

.toggle-wrapper{
  display:flex;
  justify-content:center;
  margin-bottom:32px;
}

.toggle{
  width:64px;
  height:30px;
  background:var(--toggle-bg);
  border-radius:999px;
  position:relative;
  cursor:pointer;
  border:1px solid var(--border);
}

.toggle-circle{
  width:26px;
  height:26px;
  background:white;
  border-radius:50%;
  position:absolute;
  top:1.5px;
  left:2px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  transition:transform 0.35s ease;
}

body.dark .toggle-circle{
  transform:translateX(32px);
}

input{
  width:100%;
  padding:16px;
  font-size:16px;
  border-radius:16px;
  border:1px solid var(--input-border);
  background:var(--card);
  box-sizing:border-box;
  outline:none;
  color:var(--brown);
  margin-bottom:14px;
  transition:all 0.2s ease;
}

input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(79,159,184,0.15);
}

.search-btn{
  font-family:'Zen Maru Gothic',sans-serif;
  padding:10px 24px;
  font-size:16px;
  font-weight:600;
  background:var(--accent);
  color:white;
  border:none;
  border-radius:999px;
  display:block;
  margin:0 auto;
  cursor:pointer;
  transition:opacity 0.2s ease, transform 0.1s ease;
}

.search-btn:hover{ opacity:0.85; }
.search-btn:active{ transform:scale(0.98); }

.card{
  position:relative;
  background:var(--card);
  margin-top:22px;
  padding:22px;
  border-radius:20px;
  border:1px solid var(--border);
  cursor:pointer;
  transition:transform 0.15s ease, box-shadow 0.15s ease;
}

.card:hover{
  transform:translateY(-4px);
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.card:active{
  transform:scale(0.97);
}

body.dark .card:hover{
  transform:translateY(-4px);
  box-shadow:
    0 10px 28px rgba(0,0,0,0.45),      /* Ê∑±„ÅÑÂΩ± */
    0 0 0 1px rgba(124,195,218,0.25), /* „ÅÜ„Å£„Åô„ÇâÁ∏Å */
    0 0 18px rgba(124,195,218,0.25);  /* Èùí„Ç∞„É≠„Éº */
}

body.dark .card{
  box-shadow:0 4px 14px rgba(0,0,0,0.35);
}

.zip{
  font-weight:700;
  font-size:19px;
  margin-bottom:6px;
  color:var(--title);
}

.address{
  color:var(--brown);
  font-weight:500;
  font-size:15px;
}

.message{
  margin-top:28px;
  text-align:center;
  font-size:15px;
  font-weight:500;
  color:var(--brown);
}

/* ===== v1.1.5 „Ç≥„Éî„ÉºË°®Á§∫ ===== */

.copy-toast{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%) scale(0.92);

  /* ÈÄèÈÅé */
  background:rgba(255,255,255,0.18);
  backdrop-filter:blur(8px);
  -webkit-backdrop-filter:blur(8px);

  border:1px solid var(--accent);
  box-shadow:0 6px 18px rgba(0,0,0,0.12);

  color:var(--accent);
  padding:14px 22px;
  border-radius:999px;
  font-size:16px;
  font-weight:600;

  opacity:0;
  transition:opacity 0.25s ease, transform 0.25s ease;
  pointer-events:none;
}

.copy-toast.show{
  opacity:1;
  transform:translate(-50%, -50%) scale(1);
}

/* „ÉÄ„Éº„ÇØ„ÅØÂæìÊù•ÈÄö„Çä */

body.dark .copy-toast{
  background:rgba(255,255,255,0.12);
  border:1px solid rgba(255,255,255,0.25);
  box-shadow:0 8px 20px rgba(0,0,0,0.35);
  color:#ffffff;
}

.version{
  margin-top:50px;
  text-align:center;
  font-size:12px;
  opacity:0.6;
  color:var(--brown);
}
</style>
</head>

<body>
<div class="container">

<div class="title">üìÆÈÉµ‰æøÁï™Âè∑Ê§úÁ¥¢üíå</div>

<div class="toggle-wrapper">
  <div class="toggle" onclick="toggleDarkMode()">
    <div class="toggle-circle" id="toggleIcon">üåô</div>
  </div>
</div>

<input type="text" id="address" placeholder="‰æãÔºöÈùôÂ≤°Áúå‰∏âÂ≥∂ / Â≤°Â¥é Â§ßË•ø„ÄÄ/ Á•ûÊ•ΩÂùÇ">
<button class="search-btn" onclick="searchAddress()">Ê§úÁ¥¢</button>

<div id="result"></div>

<div class="version">Zip Search v1.1.5</div>

</div>

<script>

/* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ */
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
}
updateIcon();

function toggleDarkMode(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",
    document.body.classList.contains("dark")?"dark":"light"
  );
  updateIcon();
}

function updateIcon(){
  document.getElementById("toggleIcon").textContent =
    document.body.classList.contains("dark")?"‚òÄÔ∏è":"üåô";
}

/* „Ç≥„Éî„Éº */
function copyText(text, card){
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(text);
  }else{
    const textarea=document.createElement("textarea");
    textarea.value=text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand("copy");
    document.body.removeChild(textarea);
  }

  const toast=document.createElement("div");
  toast.className="copy-toast";
  toast.innerText="„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü";
  card.appendChild(toast);

  setTimeout(()=>toast.classList.add("show"),10);
  setTimeout(()=>toast.remove(),1000);
}

/* ===== Ê§úÁ¥¢„É≠„Ç∏„ÉÉ„ÇØÔºàv1.1.3„Å®ÂêåÁ≠âÔºâ ===== */

let zipData=[];
let validSingleCharSet=new Set();
let dataLoaded=false;
let allResults=[];
let displayedCount=0;
const displayStep=20;

async function loadCSV(){
  const response=await fetch("utf_ken_all.csv");
  const text=await response.text();
  const lines=text.split("\n");

  zipData=lines
    .map(line=>line.split(","))
    .filter(cols=>cols.length>8)
    .map(cols=>{
      const prefRaw=cols[6].replace(/"/g,"");
      const cityRaw=cols[7].replace(/"/g,"");
      const townRaw=cols[8].replace(/"/g,"");

      const prefNorm=normalize(prefRaw);

      let cityMajor="";
      let cityMinor="";

      if(prefNorm==="Êù±‰∫¨"){
        cityMinor=normalize(cityRaw);
      }else{
        const match=cityRaw.match(/(.+?)Â∏Ç(.+Âå∫)?/);
        if(match){
          cityMajor=normalize(match[1]);
          cityMinor=match[2]?normalize(match[2]):"";
        }else{
          cityMajor=normalize(cityRaw);
        }
      }

      const townNorm=normalize(townRaw);

      if(cityMinor.length===1) validSingleCharSet.add(cityMinor);
      if(townNorm.length===1) validSingleCharSet.add(townNorm);

      return{
        zipcode:cols[2].replace(/"/g,""),
        pref:prefNorm,
        cityMajor,
        cityMinor,
        town:townNorm,
        displayPref:prefRaw,
        displayCity:cityRaw,
        displayTown:townRaw
      };
    });

  dataLoaded=true;
}
loadCSV();

function normalize(str){
  return str.replace(/ÈÉΩ|ÈÅì|Â∫ú|Áúå|Â∏Ç|Âå∫|Áî∫|Êùë/g,"").replace(/\s+/g,"");
}

function formatZip(zip){
  return zip.length===7?zip.slice(0,3)+"-"+zip.slice(3):zip;
}

function searchAddress(){
  const input=document.getElementById("address").value.trim();
  const resultDiv=document.getElementById("result");
  resultDiv.innerHTML="";

  if(!dataLoaded){
    resultDiv.innerHTML='<div class="message">„Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠‚Ä¶Â∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ</div>';
    return;
  }

  if(!input){
    resultDiv.innerHTML='<div class="message">‰ΩèÊâÄ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
    return;
  }

  const tokens=input.split(/\s+/).map(t=>normalize(t));

  if(tokens.length===1 && tokens[0].length===1){
    if(!validSingleCharSet.has(tokens[0])){
      resultDiv.innerHTML='<div class="message">Ë©≤ÂΩì„Åô„ÇãÂú∞Âêç„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
      return;
    }
  }

  allResults=zipData.filter(item=>{
    const full=item.pref+item.cityMajor+item.cityMinor+item.town;
    let pos=0;
    for(let token of tokens){
      const index=full.indexOf(token,pos);
      if(index===-1) return false;
      pos=index+token.length;
    }
    return true;
  });

  if(allResults.length===0){
    resultDiv.innerHTML='<div class="message">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div>';
    return;
  }

  const lastToken=tokens[tokens.length-1];

  allResults=allResults.map(item=>{
    let score=0;
    if(item.cityMajor===lastToken) score=120;
    else if(item.cityMinor===lastToken) score=110;
    else if(item.town===lastToken) score=100;
    else if(item.cityMajor.startsWith(lastToken)) score=90;
    else if(item.cityMinor.startsWith(lastToken)) score=85;
    else if(item.town.startsWith(lastToken)) score=80;
    else if(item.cityMajor.includes(lastToken)) score=70;
    else if(item.cityMinor.includes(lastToken)) score=65;
    else if(item.town.includes(lastToken)) score=60;
    return {...item,score};
  });

  allResults.sort((a,b)=>b.score-a.score);

  displayedCount=displayStep;
  renderResults();
}

function renderResults(){
  const resultDiv=document.getElementById("result");
  resultDiv.innerHTML="";

  const total=allResults.length;
  const visible=Math.min(displayedCount,total);

  const info=document.createElement("div");
  info.className="message";
  info.innerText=`${total}‰ª∂‰∏≠ 1-${visible}‰ª∂„ÇíË°®Á§∫`;
  resultDiv.appendChild(info);

  allResults.slice(0,visible).forEach(item=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="zip">„Äí${formatZip(item.zipcode)}</div>
      <div class="address">${item.displayPref}${item.displayCity}${item.displayTown}</div>
    `;
    div.onclick=()=>copyText(formatZip(item.zipcode),div);
    resultDiv.appendChild(div);
  });

  if(visible<total){
    const moreBtn=document.createElement("button");
    moreBtn.innerText="„Åï„Çâ„Å´Ë°®Á§∫";
    moreBtn.className="search-btn";
    moreBtn.style.marginTop="16px";
    moreBtn.onclick=()=>{
      displayedCount+=displayStep;
      renderResults();
    };
    resultDiv.appendChild(moreBtn);
  }
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>