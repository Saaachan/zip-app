<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Zip Search</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4f9fb8">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
@import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap');

:root {
  --bg: #f4f8fb;
  --text: #2f3a40;
  --title: #3e7c92;
  --accent: #4f9fb8;
  --card: #ffffff;
  --border: #e3f0f5;
  --input-border: #cfe3ea;
  --brown: #4a3f35;
  --toggle-bg: #ddeff5;
}

body.dark {
  --bg: #161c20;
  --text: #e6edf1;
  --title: #7cc3da;
  --accent: #3c8aa3;
  --card: #1f262b;
  --border: #2c3940;
  --input-border: #2c3940;
  --brown: #e6ded6;
  --toggle-bg: #2a3338;
}

body {
  font-family: 'Zen Maru Gothic', sans-serif;
  background: var(--bg);
  margin: 0;
  padding: 60px 20px;
  display: flex;
  justify-content: center;
  color: var(--text);
}

.container {
  width: 100%;
  max-width: 500px;
}

.title {
  text-align: center;
  font-size: 26px;
  font-weight: 700;
  color: var(--title);
  margin-bottom: 30px;
}

.toggle-wrapper {
  display: flex;
  justify-content: center;
  margin-bottom: 32px;
}

.toggle {
  width: 64px;
  height: 30px;
  background: var(--toggle-bg);
  border-radius: 999px;
  position: relative;
  cursor: pointer;
  border: 1px solid var(--border);
}

.toggle-circle {
  width: 26px;
  height: 26px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 1.5px;
  left: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  transition: transform 0.35s ease;
}

body.dark .toggle-circle {
  transform: translateX(32px);
}

input {
  width: 100%;
  padding: 16px;
  font-size: 16px;
  border-radius: 16px;
  border: 1px solid var(--input-border);
  background: var(--card);
  box-sizing: border-box;
  outline: none;
  color: var(--brown);
  font-family: 'Zen Maru Gothic', sans-serif;
}

input::placeholder {
  color: #a08c7e;
}

.search-btn {
  margin-top: 20px;
  padding: 12px 28px;
  font-size: 17px;
  font-weight: 600;
  font-family: 'Zen Maru Gothic', sans-serif;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 999px;
  display: block;
  margin-left: auto;
  margin-right: auto;
  cursor: pointer;
}

.card {
  background: var(--card);
  margin-top: 22px;
  padding: 22px;
  border-radius: 20px;
  border: 1px solid var(--border);
}

.zip {
  font-weight: 700;
  font-size: 19px;
  margin-bottom: 6px;
  color: var(--title);
}

.address {
  color: var(--brown);
  font-weight: 500;
  font-size: 15px;
}

.message {
  margin-top: 28px;
  text-align: center;
  font-size: 15px;
  font-weight: 500;
  color: var(--brown);
}
</style>
</head>

<body>
<div class="container">

<div class="title">ğŸ“®éƒµä¾¿ç•ªå·æ¤œç´¢ğŸ’Œ</div>

<div class="toggle-wrapper">
  <div class="toggle" onclick="toggleDarkMode()">
    <div class="toggle-circle" id="toggleIcon">ğŸŒ™</div>
  </div>
</div>

<input type="text" id="address" placeholder="ä¾‹ï¼šåå¤å±‹å¸‚ä¸­åŒº / å²¡å´ å¤§è¥¿">
<button class="search-btn" onclick="searchAddress()">æ¤œç´¢</button>

<div id="result"></div>

</div>

<script>
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
}
updateIcon();

function toggleDarkMode() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  localStorage.setItem("theme", isDark ? "dark" : "light");
  updateIcon();
}

function updateIcon() {
  const icon = document.getElementById("toggleIcon");
  icon.textContent = document.body.classList.contains("dark") ? "â˜€ï¸" : "ğŸŒ™";
}

let zipData = [];
let dataLoaded = false;
let allResults = [];
let displayedCount = 0;
const displayStep = 20;

async function loadCSV() {
  const response = await fetch("utf_ken_all.csv");
  const text = await response.text();
  const lines = text.split("\n");

  zipData = lines
    .map(line => line.split(","))
    .filter(cols => cols.length > 8)
    .map(cols => ({
      zipcode: cols[2].replace(/"/g, ""),
      pref: cols[6].replace(/"/g, ""),
      city: cols[7].replace(/"/g, ""),
      town: cols[8].replace(/"/g, "")
    }));

  dataLoaded = true;
}
loadCSV();

function formatZip(zip) {
  return zip.length === 7 ? zip.slice(0,3) + "-" + zip.slice(3) : zip;
}

function normalize(str) {
  return str
    .replace(/éƒ½|é“|åºœ|çœŒ|å¸‚|åŒº|ç”º|æ‘/g, "")
    .replace(/\s+/g, "");
}

function searchAddress() {
  const input = document.getElementById("address").value.trim();
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  if (!dataLoaded) {
    resultDiv.innerHTML = '<div class="message">ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­â€¦å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</div>';
    return;
  }

  if (!input) {
    resultDiv.innerHTML = '<div class="message">ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
    return;
  }

  const rawTokens = input.trim().split(/\s+/).map(t => normalize(t));

  // ğŸ”¥ 1æ–‡å­—ãƒˆãƒ¼ã‚¯ãƒ³é™¤å¤–
  const tokens = rawTokens.filter(t => t.length >= 2);

  allResults = zipData.filter(item => {

    const pref = normalize(item.pref);
    const city = normalize(item.city);
    const town = normalize(item.town);

    // ç©ºç™½ãªã—ï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰
    if (tokens.length === 1 && rawTokens.length === 1) {
      const token = tokens[0];
      if (!token) return false;

      return (
        pref === token ||
        city.startsWith(token) ||
        town.startsWith(token)
      );
    }

    // ç©ºç™½ã‚ã‚Š â†’ é †ç•ªä¿æŒANDæ¤œç´¢
    let fields = [pref, city, town];
    let fieldIndex = 0;

    for (let token of tokens) {
      let found = false;

      for (let i = fieldIndex; i < fields.length; i++) {

        if (i < 2 && fields[i].startsWith(token)) {
          fieldIndex = i + 1;
          found = true;
          break;
        }

        if (i === 2 && fields[i].startsWith(token)) {
          fieldIndex = i + 1;
          found = true;
          break;
        }
      }

      if (!found) return false;
    }

    return tokens.length > 0;
  });

  if (allResults.length === 0) {
    resultDiv.innerHTML = '<div class="message">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
    return;
  }

  displayedCount = displayStep;
  renderResults();
}

function renderResults() {
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  const total = allResults.length;
  const visible = Math.min(displayedCount, total);

  const info = document.createElement("div");
  info.className = "message";
  info.innerText = `å…¨${total}ä»¶ä¸­ 1-${visible}ä»¶ã‚’è¡¨ç¤º`;
  resultDiv.appendChild(info);

  allResults.slice(0, visible).forEach(item => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="zip">ã€’${formatZip(item.zipcode)}</div>
      <div class="address">${item.pref}${item.city}${item.town}</div>
    `;
    div.onclick = () => {
      navigator.clipboard.writeText(formatZip(item.zipcode));
      alert("éƒµä¾¿ç•ªå·ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    };
    resultDiv.appendChild(div);
  });

  if (visible < total) {
    const moreBtn = document.createElement("button");
    moreBtn.innerText = "ã•ã‚‰ã«è¡¨ç¤º";
    moreBtn.className = "search-btn";
    moreBtn.style.marginTop = "16px";
    moreBtn.onclick = () => {
      displayedCount += displayStep;
      renderResults();
    };
    resultDiv.appendChild(moreBtn);
  }
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>